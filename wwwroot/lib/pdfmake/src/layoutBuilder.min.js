/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/pdfmake@0.1.68/src/layoutBuilder.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";var TraversalTracker=require("./traversalTracker"),DocPreprocessor=require("./docPreprocessor"),DocMeasure=require("./docMeasure"),DocumentContext=require("./documentContext"),PageElementWriter=require("./pageElementWriter"),ColumnCalculator=require("./columnCalculator"),TableProcessor=require("./tableProcessor"),Line=require("./line"),isString=require("./helpers").isString,isArray=require("./helpers").isArray,isUndefined=require("./helpers").isUndefined,isNull=require("./helpers").isNull,pack=require("./helpers").pack,offsetVector=require("./helpers").offsetVector,fontStringify=require("./helpers").fontStringify,getNodeId=require("./helpers").getNodeId,isFunction=require("./helpers").isFunction,TextTools=require("./textTools"),StyleContextStack=require("./styleContextStack"),isNumber=require("./helpers").isNumber;function addAll(e,t){t.forEach(function(t){e.push(t)})}function LayoutBuilder(e,t,i,r){this.pageSize=e,this.pageMargins=t,this.tracker=new TraversalTracker,this.imageMeasure=i,this.svgMeasure=r,this.tableLayouts={}}function decorateNode(e){var t=e.x,i=e.y;e.positions=[],isArray(e.canvas)&&e.canvas.forEach(function(e){var t=e.x,i=e.y,r=e.x1,o=e.y1,n=e.x2,a=e.y2;e.resetXY=function(){e.x=t,e.y=i,e.x1=r,e.y1=o,e.x2=n,e.y2=a}}),e.resetXY=function(){e.x=t,e.y=i,isArray(e.canvas)&&e.canvas.forEach(function(e){e.resetXY()})}}LayoutBuilder.prototype.registerTableLayouts=function(e){this.tableLayouts=pack(this.tableLayouts,e)},LayoutBuilder.prototype.layoutDocument=function(e,t,i,r,o,n,a,s,c,l){function u(e,t){if(!isFunction(l))return!1;(e=e.filter(function(e){return e.positions.length>0})).forEach(function(e){var i={};["id","text","ul","ol","table","image","qr","canvas","svg","columns","headlineLevel","style","pageBreak","pageOrientation","width","height"].forEach(function(t){void 0!==e[t]&&(i[t]=e[t])}),i.startPosition=e.positions[0],i.pageNumbers=e.positions.map(function(e){return e.pageNumber}).filter(function(e,t,i){return i.indexOf(e)===t}),i.pages=t.length,i.stack=isArray(e.stack),e.nodeInfo=i});for(var i=0;i<e.length;i++){var r=e[i];if("before"!==r.pageBreak&&!r.pageBreakCalculated){r.pageBreakCalculated=!0;for(var o=r.nodeInfo.pageNumbers[0],n=[],a=[],s=[],c=i+1,u=e.length;c<u;c++)e[c].nodeInfo.pageNumbers.indexOf(o)>-1&&n.push(e[c].nodeInfo),e[c].nodeInfo.pageNumbers.indexOf(o+1)>-1&&a.push(e[c].nodeInfo);for(c=0;c<i;c++)e[c].nodeInfo.pageNumbers.indexOf(o)>-1&&s.push(e[c].nodeInfo);if(l(r.nodeInfo,n,a,s))return r.pageBreak="before",!0}}return!1}function p(e){e.linearNodeList.forEach(function(e){e.resetXY()})}this.docPreprocessor=new DocPreprocessor,this.docMeasure=new DocMeasure(t,i,r,this.imageMeasure,this.svgMeasure,this.tableLayouts,s);for(var d=this.tryLayoutDocument(e,t,i,r,o,n,a,s,c);u(d.linearNodeList,d.pages);)p(d),d=this.tryLayoutDocument(e,t,i,r,o,n,a,s,c);return d.pages},LayoutBuilder.prototype.tryLayoutDocument=function(e,t,i,r,o,n,a,s,c,l){this.linearNodeList=[],e=this.docPreprocessor.preprocessDocument(e),e=this.docMeasure.measureDocument(e),this.writer=new PageElementWriter(new DocumentContext(this.pageSize,this.pageMargins),this.tracker);var u=this;return this.writer.context().tracker.startTracking("pageAdded",function(){u.addBackground(o)}),this.addBackground(o),this.processNode(e),this.addHeadersAndFooters(n,a),null!=c&&this.addWatermark(c,t,r),{pages:this.writer.context().pages,linearNodeList:this.linearNodeList}},LayoutBuilder.prototype.addBackground=function(e){var t=isFunction(e)?e:function(){return e},i=this.writer.context(),r=i.getCurrentPage().pageSize,o=t(i.page+1,r);o&&(this.writer.beginUnbreakableBlock(r.width,r.height),o=this.docPreprocessor.preprocessDocument(o),this.processNode(this.docMeasure.measureDocument(o)),this.writer.commitUnbreakableBlock(0,0),i.backgroundLength[i.page]+=o.positions.length)},LayoutBuilder.prototype.addStaticRepeatable=function(e,t){this.addDynamicRepeatable(function(){return JSON.parse(JSON.stringify(e))},t)},LayoutBuilder.prototype.addDynamicRepeatable=function(e,t){for(var i=0,r=this.writer.context().pages.length;i<r;i++){this.writer.context().page=i;var o=e(i+1,r,this.writer.context().pages[i].pageSize);if(o){var n=t(this.writer.context().getCurrentPage().pageSize,this.pageMargins);this.writer.beginUnbreakableBlock(n.width,n.height),o=this.docPreprocessor.preprocessDocument(o),this.processNode(this.docMeasure.measureDocument(o)),this.writer.commitUnbreakableBlock(n.x,n.y)}}},LayoutBuilder.prototype.addHeadersAndFooters=function(e,t){var i=function(e,t){return{x:0,y:0,width:e.width,height:t.top}},r=function(e,t){return{x:0,y:e.height-t.bottom,width:e.width,height:t.bottom}};isFunction(e)?this.addDynamicRepeatable(e,i):e&&this.addStaticRepeatable(e,i),isFunction(t)?this.addDynamicRepeatable(t,r):t&&this.addStaticRepeatable(t,r)},LayoutBuilder.prototype.addWatermark=function(e,t,i){if(isString(e)&&(e={text:e}),e.text){e.font=e.font||i.font||"Roboto",e.fontSize=e.fontSize||"auto",e.color=e.color||"black",e.opacity=isNumber(e.opacity)?e.opacity:.6,e.bold=e.bold||!1,e.italics=e.italics||!1,e.angle=isUndefined(e.angle)||isNull(e.angle)?null:e.angle,null===e.angle&&(e.angle=-180*Math.atan2(this.pageSize.height,this.pageSize.width)/Math.PI),"auto"===e.fontSize&&(e.fontSize=function(e,t,i){var r,o=new TextTools(i),n=new StyleContextStack(null,{font:t.font,bold:t.bold,italics:t.italics}),a=0,s=1e3,c=(a+s)/2;for(;Math.abs(a-s)>1;)n.push({fontSize:c}),(r=o.sizeOfRotatedText(t.text,t.angle,n)).width>e.width?c=(a+(s=c))/2:r.width<e.width&&(c=r.height>e.height?(a+(s=c))/2:((a=c)+s)/2),n.pop();return c}(this.pageSize,e,t));var r={text:e.text,font:t.provideFont(e.font,e.bold,e.italics),fontSize:e.fontSize,color:e.color,opacity:e.opacity,angle:e.angle};r._size=function(e,t){var i=new TextTools(t),r=new StyleContextStack(null,{font:e.font,bold:e.bold,italics:e.italics});r.push({fontSize:e.fontSize});var o=i.sizeOfString(e.text,r),n=i.sizeOfRotatedText(e.text,e.angle,r);return{size:o,rotatedSize:n}}(e,t);for(var o=this.writer.context().pages,n=0,a=o.length;n<a;n++)o[n].watermark=r}},LayoutBuilder.prototype.processNode=function(e){var t=this;this.linearNodeList.push(e),decorateNode(e),function(i){var r=e._margin;"before"===e.pageBreak?t.writer.moveToNextPage(e.pageOrientation):"beforeOdd"===e.pageBreak?(t.writer.moveToNextPage(e.pageOrientation),(t.writer.context().page+1)%2==1&&t.writer.moveToNextPage(e.pageOrientation)):"beforeEven"===e.pageBreak&&(t.writer.moveToNextPage(e.pageOrientation),(t.writer.context().page+1)%2==0&&t.writer.moveToNextPage(e.pageOrientation));r&&(t.writer.context().moveDown(r[1]),t.writer.context().addMargin(r[0],r[2]));i(),r&&(t.writer.context().addMargin(-r[0],-r[2]),t.writer.context().moveDown(r[3]));"after"===e.pageBreak?t.writer.moveToNextPage(e.pageOrientation):"afterOdd"===e.pageBreak?(t.writer.moveToNextPage(e.pageOrientation),(t.writer.context().page+1)%2==1&&t.writer.moveToNextPage(e.pageOrientation)):"afterEven"===e.pageBreak&&(t.writer.moveToNextPage(e.pageOrientation),(t.writer.context().page+1)%2==0&&t.writer.moveToNextPage(e.pageOrientation))}(function(){var i=e.unbreakable;i&&t.writer.beginUnbreakableBlock();var r=e.absolutePosition;r&&(t.writer.context().beginDetachedBlock(),t.writer.context().moveTo(r.x||0,r.y||0));var o=e.relativePosition;if(o&&(t.writer.context().beginDetachedBlock(),t.writer.context().moveToRelative(o.x||0,o.y||0)),e.stack)t.processVerticalContainer(e);else if(e.columns)t.processColumns(e);else if(e.ul)t.processList(!1,e);else if(e.ol)t.processList(!0,e);else if(e.table)t.processTable(e);else if(void 0!==e.text)t.processLeaf(e);else if(e.toc)t.processToc(e);else if(e.image)t.processImage(e);else if(e.svg)t.processSVG(e);else if(e.canvas)t.processCanvas(e);else if(e.qr)t.processQr(e);else if(!e._span)throw"Unrecognized document structure: "+JSON.stringify(e,fontStringify);(r||o)&&t.writer.context().endDetachedBlock(),i&&t.writer.commitUnbreakableBlock()})},LayoutBuilder.prototype.processVerticalContainer=function(e){var t=this;e.stack.forEach(function(i){t.processNode(i),addAll(e.positions,i.positions)})},LayoutBuilder.prototype.processColumns=function(e){var t=e.columns,i=this.writer.context().availableWidth,r=function(e){if(!e)return null;var i=[];i.push(0);for(var r=t.length-1;r>0;r--)i.push(e);return i}(e._gap);r&&(i-=(r.length-1)*e._gap),ColumnCalculator.buildColumnWidths(t,i);var o=this.processRow(t,t,r);addAll(e.positions,o.positions)},LayoutBuilder.prototype.processRow=function(e,t,i,r,o,n){var a=this,s=[],c=[];return this.tracker.auto("pageChanged",function(e){for(var t,i=0,r=s.length;i<r;i++){var o=s[i];if(o.prevPage===e.prevPage){t=o;break}}t||(t=e,s.push(t));t.prevY=Math.max(t.prevY,e.prevY),t.y=Math.min(t.y,e.y)},function(){t=t||e,a.writer.context().beginColumnGroup();for(var r=0,o=e.length;r<o;r++){var s=e[r],p=t[r]._calcWidth,d=l(r);if(s.colSpan&&s.colSpan>1)for(var h=1;h<s.colSpan;h++)p+=t[++r]._calcWidth+i[r];a.writer.context().beginColumn(p,d,u(s,r)),s._span?s._columnEndingContext&&a.writer.context().markEnding(s):(a.processNode(s),addAll(c,s.positions))}a.writer.context().completeColumnGroup(n)}),{pageBreaks:s,positions:c};function l(e){return i&&i.length>e?i[e]:0}function u(e,t){if(e.rowSpan&&e.rowSpan>1){var i=o+e.rowSpan-1;if(i>=r.length)throw"Row span for column "+t+" (with indexes starting from 0) exceeded row count";return r[i][t]}return null}},LayoutBuilder.prototype.processList=function(e,t){var i,r=this,o=e?t.ol:t.ul,n=t._gapSize;this.writer.context().addMargin(n.width),this.tracker.auto("lineAdded",function(e){if(i){var t=i;if(i=null,t.canvas){var o=t.canvas[0];offsetVector(o,-t._minWidth,0),r.writer.addVector(o)}else if(t._inlines){var n=new Line(r.pageSize.width);n.addInline(t._inlines[0]),n.x=-t._minWidth,n.y=e.getAscenderHeight()-n.getAscenderHeight(),r.writer.addLine(n,!0)}}},function(){o.forEach(function(e){i=e.listMarker,r.processNode(e),addAll(t.positions,e.positions)})}),this.writer.context().addMargin(-n.width)},LayoutBuilder.prototype.processTable=function(e){var t=new TableProcessor(e);t.beginTable(this.writer);for(var i=e.table.heights,r=0,o=e.table.body.length;r<o;r++){var n;t.beginRow(r,this.writer),"auto"===(n=isFunction(i)?i(r):isArray(i)?i[r]:i)&&(n=void 0);var a=this.processRow(e.table.body[r],e.table.widths,e._offsets.offsets,e.table.body,r,n);addAll(e.positions,a.positions),t.endRow(r,this.writer,a.pageBreaks)}t.endTable(this.writer)},LayoutBuilder.prototype.processLeaf=function(e){var t=this.buildNextLine(e);t&&(e.tocItem||e.id)&&(t._node=e);var i=t?t.getHeight():0,r=e.maxHeight||-1;if(t){var o=getNodeId(e);o&&(t.id=o)}if(e._tocItemRef&&(t._pageNodeRef=e._tocItemRef),e._pageRef&&(t._pageNodeRef=e._pageRef._nodeRef),t&&t.inlines&&isArray(t.inlines))for(var n=0,a=t.inlines.length;n<a;n++)t.inlines[n]._tocItemRef&&(t.inlines[n]._pageNodeRef=t.inlines[n]._tocItemRef),t.inlines[n]._pageRef&&(t.inlines[n]._pageNodeRef=t.inlines[n]._pageRef._nodeRef);for(;t&&(-1===r||i<r);){var s=this.writer.addLine(t);e.positions.push(s),(t=this.buildNextLine(e))&&(i+=t.getHeight())}},LayoutBuilder.prototype.processToc=function(e){e.toc.title&&this.processNode(e.toc.title),e.toc._table&&this.processNode(e.toc._table)},LayoutBuilder.prototype.buildNextLine=function(e){function t(e){var t=e.constructor();for(var i in e)t[i]=e[i];return t}if(!e._inlines||0===e._inlines.length)return null;for(var i=new Line(this.writer.context().availableWidth),r=new TextTools(null),o=!1;e._inlines&&e._inlines.length>0&&(i.hasEnoughSpaceForInline(e._inlines[0],e._inlines.slice(1))||o);){var n=!1,a=e._inlines.shift();if(o=!1,!a.noWrap&&a.text.length>1&&a.width>i.getAvailableWidth()){var s=a.width/a.text.length,c=Math.floor(i.getAvailableWidth()/s);if(c<1&&(c=1),c<a.text.length){var l=t(a);l.text=a.text.substr(c),a.text=a.text.substr(0,c),l.width=r.widthOfString(l.text,l.font,l.fontSize,l.characterSpacing,l.fontFeatures),a.width=r.widthOfString(a.text,a.font,a.fontSize,a.characterSpacing,a.fontFeatures),e._inlines.unshift(l),n=!0}}i.addInline(a),o=a.noNewLine&&!n}return i.lastLineInParagraph=0===e._inlines.length,i},LayoutBuilder.prototype.processImage=function(e){var t=this.writer.addImage(e);e.positions.push(t)},LayoutBuilder.prototype.processSVG=function(e){var t=this.writer.addSVG(e);e.positions.push(t)},LayoutBuilder.prototype.processCanvas=function(e){var t=e._minHeight;void 0===e.absolutePosition&&this.writer.context().availableHeight<t&&this.writer.moveToNextPage(),this.writer.alignCanvas(e),e.canvas.forEach(function(t){var i=this.writer.addVector(t);e.positions.push(i)},this),this.writer.context().moveDown(t)},LayoutBuilder.prototype.processQr=function(e){var t=this.writer.addQr(e);e.positions.push(t)},module.exports=LayoutBuilder;
//# sourceMappingURL=/sm/12c95537129be1ee81ae119ad7c06e3c1c761685327021bfc5a26ff624eb6549.map